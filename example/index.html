<!DOCTYPE html>
<html>
<body>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/rtc-data-connection-manager.js"></script>
    <script type="text/javascript">
        function init(location) {
            var DataConnectionManager = require('rtc-data-connection-manager');

            var dm = new DataConnectionManager();
            dm.location = location;
            var socket = io.connect();

            function WebSocketRelay(socket, toId) {
                this.on = function (name, handler) {
                    socket.on.call(socket, '__relay__:' + name, handler);
                };
                this.emit = function (name, data) {
                    socket.emit('msg', toId, '__relay__:' + name, data);
                };
            }

            function handleServerPeer(socket, id, offer) {
                var relay = new WebSocketRelay(socket, id);
                dm.createPeer(relay, id, offer);
            }

            socket.on('peer', function (id) {
                handleServerPeer(socket, id);
            });
            socket.on('__relay__:offer', function (offer, id) {
                handleServerPeer(socket, id, offer);
            });
        }
        navigator.geolocation.getCurrentPosition(init, console.error.bind(console));
    </script>
</body>
</html>
